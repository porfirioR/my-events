<section class="container mx-auto px-4 py-8">
  @if (operation(); as op) {
    <article class="max-w-4xl mx-auto">
      <!-- Header -->
      <header class="bg-base-200 dark:bg-base-300 rounded-xl shadow-lg p-6 mb-6">
        <div class="flex items-start justify-between gap-4">
          <button
            type="button"
            class="btn btn-sm btn-ghost btn-circle"
            (click)="backToTravel()"
          >
            <i class="fas fa-arrow-left"></i>
          </button>

          <div class="flex-grow">
            <h1 class="text-2xl md:text-3xl font-bold text-base-content mb-2">
              {{ op.description }}
            </h1>

            <!-- Travel Info -->
            @if (travel(); as travelData) {
              <p class="text-base-content/70 mb-3">
                <i class="fas fa-plane-departure mr-2"></i>
                {{ travelData.name }}
              </p>
            }

            <!-- Metadata original (limpio) -->
            <div class="flex items-center gap-4 flex-wrap">
              <!-- Status Badge -->
              <span class="badge badge-outline badge-lg flex items-baseline"
                [ngClass]="getOperationStatusBadgeClass(op.status)">
                <i [class]="'fas ' + getOperationStatusIcon(op.status) + ' mr-2'"></i>
                {{ 'travels.' + op.status.toLowerCase() | translate }}
              </span>

              <!-- Date -->
              <time class="text-sm text-base-content/70" [attr.datetime]="op.transactionDate">
                <i class="fas fa-calendar-alt mr-1"></i>
                {{ getFormattedDateCustom(op.transactionDate) }}
              </time>

              <!-- Participants -->
              @if (op.participantCount) {
                <span class="text-sm text-base-content/70">
                  <i class="fas fa-users mr-1"></i>
                  {{ op.participantCount }} {{ 'travels.participants' | translate }}
                </span>
              }
            </div>

            <p class="text-base-content/70 mt-3">
              Categoria: {{selectedCategory()?.icon}} {{'categories.' + selectedCategory()?.name | translate}}
            </p>
          </div>

          <!-- Action Buttons -->
          <div class="flex gap-2 flex-col lg:flex-row">
            @if (op.status === approvalStatus.Pending && travel()?.status === 'Active') {
              @if (hasCurrentUserApproved(op)) {
                <div class="flex items-center gap-2 px-3 py-2 bg-success/10 rounded-lg">
                  <i class="fas fa-check-circle text-success"></i>
                  <span class="text-sm text-success font-medium">
                    {{ 'operations.youAlreadyApproved' | translate }}
                  </span>
                </div>
              }
              @if (canCurrentUserApprove(op)) {
                <button
                  type="button"
                  class="btn btn-sm btn-outline btn-success"
                  (click)="approveOperation()"
                >
                  <i class="fas fa-check"></i>
                  <span class="hidden md:inline ml-1">{{ 'travels.approve' | translate }}</span>
                </button>
              }
              @if (canCurrentUserReject(op)) {
                <button
                  type="button"
                  class="btn btn-sm btn-outline btn-error"
                  (click)="rejectOperation()"
                >
                  <i class="fas fa-times"></i>
                  <span class="hidden md:inline ml-1">{{ 'travels.reject' | translate }}</span>
                </button>
              }
              <button
                type="button"
                class="btn btn-sm btn-outline btn-primary"
                (click)="editOperation()"
              >
                <i class="fas fa-edit"></i>
                <span class="hidden md:inline ml-1">{{ 'common.edit' | translate }}</span>
              </button>
            }
            @if (op.status !== approvalStatus.Approved) {
              <button
                type="button"
                class="btn btn-sm btn-outline btn-error"
                (click)="deleteOperation()"
              >
                <i class="fas fa-trash"></i>
                <span class="hidden md:inline ml-1">
                  {{ 'common.delete' | translate }}
                </span>
              </button>
            }
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Left Column - Detalles + C치lculo (2/3 del ancho) -->
        <div class="space-y-6">
          <!-- Detalles de la Operaci칩n (restaurado) -->
          <article class="bg-base-200 dark:bg-base-300 rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-semibold text-base-content mb-4 flex items-center gap-2">
              <i class="fas fa-info-circle text-primary"></i>
              {{ 'operations.operationDetails' | translate }}
            </h2>

            <dl class="space-y-4">
              <!-- Amount -->
              <div class="flex justify-between items-start border-b border-base-300 pb-3">
                <dt class="text-base-content/70 font-medium">{{ 'operations.amount' | translate }}</dt>
                <dd class="text-right">
                  <div class="text-2xl font-bold text-primary">
                    {{ formatCurrency(op.amount, op.currencyId) }}
                  </div>
                </dd>
              </div>

              <!-- Who Paid -->
              <div class="flex justify-between items-center border-b border-base-300 pb-3">
                <dt class="text-base-content/70 font-medium">{{ 'operations.whoPaid' | translate }}</dt>
                <dd class="text-right font-semibold text-base-content">
                  {{ op.whoPaidMemberName || ('operations.unknownMember' | translate) }}
                </dd>
              </div>

              <!-- Split Type -->
              <div class="flex justify-between items-center border-b border-base-300 pb-3">
                <dt class="text-base-content/70 font-medium">{{ 'operations.splitType' | translate }}</dt>
                <dd class="text-right">
                  <span class="badge badge-outline">{{ 'operations.' + op.splitType.toLowerCase() | translate }}</span>
                </dd>
              </div>

              <!-- Payment Method -->
              @if (op.paymentMethodName) {
                <div class="flex justify-between items-center">
                  <dt class="text-base-content/70 font-medium">{{ 'operations.paymentMethod' | translate }}</dt>
                  <dd class="text-right font-semibold text-base-content">{{ op.paymentMethodName }}</dd>
                </div>
              }
            </dl>
          </article>

          <!-- C치lculo de Divisi칩n -->
          @if (op.participantCount) {
            <article class="bg-primary/10 dark:bg-primary/20 rounded-xl p-6">
              <h3 class="font-semibold text-base-content mb-4 flex items-center gap-2">
                <i class="fas fa-calculator text-primary"></i>
                {{ 'operations.splitCalculation' | translate }}
              </h3>

              <!-- Resumen general -->
              <div class="space-y-2 mb-4 pb-4 border-b border-primary/30">
                <div class="flex justify-between items-center">
                  <span class="text-base-content/70">{{ 'operations.totalAmount' | translate }}:</span>
                  <span class="font-bold text-base-content">{{ formatCurrency(op.amount, op.currencyId) }}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-base-content/70">{{ 'operations.participants' | translate }}:</span>
                  <span class="font-bold text-base-content">{{ op.participantCount }}</span>
                </div>
              </div>

              <!-- Desglose individual -->
              @if (op.participants && op.participants.length > 0) {
                <div class="space-y-3">
                  <h4 class="text-sm font-semibold text-base-content/70">
                    {{ 'operations.individualAmounts' | translate }}:
                  </h4>
                  @for (participant of op.participants; track participant.memberId) {
                    <div class="flex items-center justify-between p-3 rounded-lg bg-base-100">
                      <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-primary text-primary-content flex items-center justify-center text-xs font-semibold">
                          {{ getInitials(participant.memberName + ' ' + participant.memberSurname) }}
                        </div>
                        <span class="text-sm font-medium text-base-content">
                          {{ participant.memberName }} {{ participant.memberSurname }}
                        </span>
                      </div>
                      <div class="text-right">
                        <div class="font-bold text-primary">
                          {{ formatCurrency(participant.shareAmount, op.currencyId) }}
                        </div>
                        @if (op.splitType === 'Percentage') {
                          <div class="text-xs text-base-content/70">
                            {{ participant.sharePercentage }}%
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>
              }
              <!-- Total por persona (solo si es Equal) -->
              @if (op.splitType === 'Equal') {
                <div class="flex justify-between items-center pt-3 mt-3 border-t border-primary/30">
                  <span class="text-base-content/70 font-medium">{{ 'operations.perPerson' | translate }}:</span>
                  <span class="text-xl font-bold text-primary">
                    {{ formatCurrency(op.amount / op.participantCount, op.currencyId) }}
                  </span>
                </div>
              }
            </article>
          }
        </div>

        <!-- Right Column - Estado + Archivos (1/3 del ancho) -->
        <aside class="space-y-6">
          <!-- Status Card con participantes -->
          <article class="bg-base-200 dark:bg-base-300 rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-base-content mb-4">
              {{ 'operations.status' | translate }}
            </h3>

            <div class="text-center py-4">
              <figure class="w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center text-white shadow-lg"
                [ngClass]="{
                  'bg-warning': op.status === approvalStatus.Pending,
                  'bg-success': op.status === approvalStatus.Approved,
                  'bg-error': op.status === approvalStatus.Rejected
                }">
                <i [class]="'fas ' + getOperationStatusIcon(op.status) + ' text-2xl'"></i>
              </figure>
              <h4 class="text-xl font-bold text-base-content mb-2">
                {{ 'travels.' + op.status.toLowerCase() | translate }}
              </h4>

              @if (op.status === approvalStatus.Pending) {
                <p class="text-sm text-base-content/70 mb-4">
                  {{ 'operations.pendingApprovalMessage' | translate }}
                </p>
              } @else if (op.status === approvalStatus.Approved) {
                <p class="text-sm text-base-content/70 mb-4">
                  {{ 'operations.approvedMessage' | translate }}
                </p>
              } @else if (op.status === approvalStatus.Rejected) {
                <p class="text-sm text-base-content/70 mb-4">
                  {{ 'operations.rejectedMessage' | translate }}
                </p>
              }

              <!-- Participantes y sus aprobaciones -->
              <div class="mt-6 pt-4 border-t border-base-300">
                <h4 class="text-sm font-semibold text-base-content mb-3 text-left">
                  {{ 'travels.participants' | translate }}:
                </h4>
                <div class="space-y-2">
                  @for (participant of op.participants || []; track participant.memberId) {
                    <div class="flex items-center justify-between p-2 rounded-lg bg-base-100">
                      <div class="flex items-center gap-2">
                        <div
                          class="w-8 h-8 rounded-full text-primary-content flex items-center justify-center text-xs font-semibold"
                          [ngClass]="{
                            'bg-success': participant.approvalStatus === approvalStatus.Approved,
                            'bg-warning': participant.approvalStatus === approvalStatus.Pending,
                            'bg-error': participant.approvalStatus === approvalStatus.Rejected,
                          }"
                        >
                          {{ getInitials(participant.memberName + ' ' + participant.memberSurname) }}
                        </div>
                        <span class="text-sm font-medium text-base-content">
                          {{ participant.memberName }} {{ participant.memberSurname }}
                        </span>
                      </div>
                      <div class="flex items-center gap-1">
                        @if (participant.approvalStatus === approvalStatus.Approved) {
                          <i class="fas fa-check-circle text-success"></i>
                          <span class="text-xs text-success font-medium">{{ 'operations.approved' | translate }}</span>
                        } @else if (participant.approvalStatus === approvalStatus.Rejected) {
                          <i class="fas fa-times-circle text-error"></i>
                          <span class="text-xs text-error font-medium">{{ 'operations.rejected' | translate }}</span>
                        } @else {
                          <i class="fas fa-clock text-warning"></i>
                          <span class="text-xs text-warning font-medium">{{ 'operations.pending' | translate }}</span>
                        }
                      </div>
                    </div>
                  }
                </div>
              </div>

              <!-- Approval Stats -->
              @if (op.status === approvalStatus.Pending && op.approvalCount !== undefined && op.participantCount) {
                <div class="mt-4 pt-4 border-t border-base-300">
                  <div class="flex justify-between items-center mb-2">
                    <span class="text-sm text-base-content/70">{{ 'operations.approvals' | translate }}</span>
                    <span class="text-sm font-bold text-base-content">
                      {{ op.approvalCount }} / {{ op.participantCount }}
                    </span>
                  </div>
                  <progress
                    class="progress progress-success w-full"
                    [ngClass]="{
                      'progress-success': op.approvalCount === op.participantCount,
                      'progress-warning': op.approvalCount !== op.participantCount
                    }"
                    [value]="op.approvalCount"
                    [max]="op.participantCount"
                  ></progress>
                </div>
              }
            </div>
          </article>

          <!-- Archivos -->
          <app-attachment-list
            [operationId]="operationId!"
            [canDelete]="operation()?.status !== approvalStatus.Approved && travel()?.status === 'Active'"
            [showUploadButton]="operation()?.status !== approvalStatus.Approved && travel()?.status === 'Active'"
          />
        </aside>
      </div>
    </article>
  } @else {
    <div class="flex justify-center items-center min-h-[50vh]">
      <span class="loading loading-spinner loading-lg"></span>
    </div>
  }
</section>