<section class="container mx-auto px-4 py-8">
  @if (operation(); as op) {
    <article class="max-w-4xl mx-auto">
      <!-- Header -->
      <header class="bg-base-200 dark:bg-base-300 rounded-xl shadow-lg p-6 mb-6">
        <div class="flex items-start justify-between gap-4">
          <button
            type="button"
            class="btn btn-sm btn-ghost btn-circle"
            (click)="backToTravel()"
          >
            <i class="fas fa-arrow-left"></i>
          </button>

          <div class="flex-grow">
            <h1 class="text-2xl md:text-3xl font-bold text-base-content mb-2">
              {{ op.description }}
            </h1>

            <!-- Travel Info -->
            @if (travel(); as travelData) {
              <p class="text-base-content/70 mb-3">
                <i class="fas fa-plane-departure mr-2"></i>
                {{ travelData.name }}
              </p>
            }

            <!-- Metadata -->
            <div class="flex items-center gap-4 flex-wrap">
              <!-- Status Badge -->
              <span class="badge badge-outline badge-lg flex items-baseline"
                [ngClass]="getOperationStatusBadgeClass(op.status)">
                <i [class]="'fas ' + getOperationStatusIcon(op.status) + ' mr-2'"></i>
                {{ 'travels.' + op.status.toLowerCase() | translate }}
              </span>

              <!-- Date -->
              <time class="text-sm text-base-content/70" [attr.datetime]="op.transactionDate">
                <i class="fas fa-calendar-alt mr-1"></i>
                {{ getFormattedDate(op.transactionDate) }}
              </time>

              <!-- Participants -->
              @if (op.participantCount) {
                <span class="text-sm text-base-content/70">
                  <i class="fas fa-users mr-1"></i>
                  {{ op.participantCount }} {{ 'travels.participants' | translate }}
                </span>
              }
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex gap-2">
            @if (op.status === 'Pending' && travel()?.status === 'Active') {
              <button
                type="button"
                class="btn btn-sm btn-success"
                (click)="approveOperation()"
              >
                <i class="fas fa-check"></i>
                <span class="hidden md:inline ml-1">{{ 'travels.approve' | translate }}</span>
              </button>
              <button
                type="button"
                class="btn btn-sm btn-error"
                (click)="rejectOperation()"
              >
                <i class="fas fa-times"></i>
                <span class="hidden md:inline ml-1">{{ 'travels.reject' | translate }}</span>
              </button>
              <button
                type="button"
                class="btn btn-sm btn-primary"
                (click)="editOperation()"
              >
                <i class="fas fa-edit"></i>
                <span class="hidden md:inline ml-1">{{ 'common.edit' | translate }}</span>
              </button>
            }
            @if (op.status !== 'Approved') {
              <button
                type="button"
                class="btn btn-sm btn-ghost text-error"
                (click)="deleteOperation()"
              >
                <i class="fas fa-trash"></i>
              </button>
            }
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column - Details -->
        <div class="lg:col-span-2 space-y-6">
          <!-- Operation Info Card -->
          <article class="bg-base-200 dark:bg-base-300 rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-semibold text-base-content mb-4 flex items-center gap-2">
              <i class="fas fa-info-circle text-primary"></i>
              {{ 'operations.operationDetails' | translate }}
            </h2>

            <dl class="space-y-4">
              <!-- Amount -->
              <div class="flex justify-between items-start border-b border-base-300 pb-3">
                <dt class="text-base-content/70 font-medium">{{ 'operations.amount' | translate }}</dt>
                <dd class="text-right">
                  <div class="text-2xl font-bold text-primary">
                    {{ formatCurrency(op.amount, op.currencyId) }}
                  </div>
                  @if (op.currencySymbol) {
                    <div class="text-xs text-base-content/60">{{ op.currencySymbol }}</div>
                  }
                </dd>
              </div>

              <!-- Who Paid -->
              <div class="flex justify-between items-center border-b border-base-300 pb-3">
                <dt class="text-base-content/70 font-medium">{{ 'operations.whoPaid' | translate }}</dt>
                <dd class="text-right font-semibold text-base-content">
                  {{ op.whoPaidMemberName || ('operations.unknownMember' | translate) }}
                </dd>
              </div>

              <!-- Split Type -->
              <div class="flex justify-between items-center border-b border-base-300 pb-3">
                <dt class="text-base-content/70 font-medium">{{ 'operations.splitType' | translate }}</dt>
                <dd class="text-right">
                  <span class="badge badge-outline">{{ 'operations.' + op.splitType.toLowerCase() | translate }}</span>
                </dd>
              </div>

              <!-- Payment Method -->
              @if (op.paymentMethodName) {
                <div class="flex justify-between items-center border-b border-base-300 pb-3">
                  <dt class="text-base-content/70 font-medium">{{ 'operations.paymentMethod' | translate }}</dt>
                  <dd class="text-right font-semibold text-base-content">{{ op.paymentMethodName }}</dd>
                </div>
              }

              <!-- Transaction Date -->
              <div class="flex justify-between items-center border-b border-base-300 pb-3">
                <dt class="text-base-content/70 font-medium">{{ 'operations.transactionDate' | translate }}</dt>
                <dd class="text-right font-semibold text-base-content">
                  {{ getFormattedDate(op.transactionDate) }}
                </dd>
              </div>

              <!-- Created Date -->
              <div class="flex justify-between items-center">
                <dt class="text-base-content/70 font-medium">{{ 'operations.createdDate' | translate }}</dt>
                <dd class="text-right text-sm text-base-content/60">
                  {{ getFormattedDate(op.dateCreated) }}
                </dd>
              </div>
            </dl>
          </article>

          <!-- Split Calculation Card (if Equal split) -->
          @if (op.splitType === 'Equal' && op.participantCount) {
            <article class="bg-primary/10 dark:bg-primary/20 rounded-xl p-6">
              <h3 class="font-semibold text-base-content mb-3 flex items-center gap-2">
                <i class="fas fa-calculator text-primary"></i>
                {{ 'operations.splitCalculation' | translate }}
              </h3>
              <div class="space-y-2">
                <div class="flex justify-between items-center">
                  <span class="text-base-content/70">{{ 'operations.totalAmount' | translate }}:</span>
                  <span class="font-bold text-base-content">{{ formatCurrency(op.amount, op.currencyId) }}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-base-content/70">{{ 'operations.participants' | translate }}:</span>
                  <span class="font-bold text-base-content">{{ op.participantCount }}</span>
                </div>
                <div class="flex justify-between items-center pt-2 border-t border-primary/30">
                  <span class="text-base-content/70">{{ 'operations.perPerson' | translate }}:</span>
                  <span class="text-xl font-bold text-primary">
                    {{ formatCurrency(op.amount / op.participantCount, op.currencyId) }}
                  </span>
                </div>
              </div>
            </article>
          }
        </div>

        <!-- Right Column - Status & Actions -->
        <aside class="space-y-6">
          <!-- Status Card -->
          <article class="bg-base-200 dark:bg-base-300 rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-base-content mb-4">
              {{ 'operations.status' | translate }}
            </h3>

            <div class="text-center py-4">
              <figure class="w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center text-white shadow-lg"
                [ngClass]="{
                  'bg-warning': op.status === 'Pending',
                  'bg-success': op.status === 'Approved',
                  'bg-error': op.status === 'Rejected'
                }">
                <i [class]="'fas ' + getOperationStatusIcon(op.status) + ' text-2xl'"></i>
              </figure>
              <h4 class="text-xl font-bold text-base-content mb-2">
                {{ 'travels.' + op.status.toLowerCase() | translate }}
              </h4>

              @if (op.status === 'Pending') {
                <p class="text-sm text-base-content/70 mb-4">
                  {{ 'operations.pendingApprovalMessage' | translate }}
                </p>
              } @else if (op.status === 'Approved') {
                <p class="text-sm text-base-content/70 mb-4">
                  {{ 'operations.approvedMessage' | translate }}
                </p>
              } @else if (op.status === 'Rejected') {
                <p class="text-sm text-base-content/70 mb-4">
                  {{ 'operations.rejectedMessage' | translate }}
                </p>
              }

              <!-- Approval Stats -->
              @if (op.status === 'Pending' && op.approvalCount !== undefined && op.participantCount) {
                <div class="mt-4 pt-4 border-t border-base-300">
                  <div class="flex justify-between items-center mb-2">
                    <span class="text-sm text-base-content/70">{{ 'operations.approvals' | translate }}</span>
                    <span class="text-sm font-bold text-base-content">
                      {{ op.approvalCount }} / {{ op.participantCount }}
                    </span>
                  </div>
                  <progress
                    class="progress progress-success w-full"
                    [value]="op.approvalCount"
                    [max]="op.participantCount"
                  ></progress>
                </div>
              }
            </div>
          </article>

          <!-- Quick Actions Card -->
          @if (op.status === 'Pending' && travel()?.status === 'Active') {
            <article class="bg-base-200 dark:bg-base-300 rounded-xl shadow-lg p-6">
              <h3 class="text-lg font-semibold text-base-content mb-4">
                {{ 'operations.quickActions' | translate }}
              </h3>
              <nav class="space-y-2">
                <button
                  type="button"
                  class="w-full btn btn-success btn-sm justify-start"
                  (click)="approveOperation()"
                >
                  <i class="fas fa-check"></i>
                  {{ 'travels.approve' | translate }}
                </button>
                <button
                  type="button"
                  class="w-full btn btn-error btn-sm justify-start"
                  (click)="rejectOperation()"
                >
                  <i class="fas fa-times"></i>
                  {{ 'travels.reject' | translate }}
                </button>
                <button
                  type="button"
                  class="w-full btn btn-outline btn-sm justify-start"
                  (click)="editOperation()"
                >
                  <i class="fas fa-edit"></i>
                  {{ 'common.edit' | translate }}
                </button>
              </nav>
            </article>
          }
        </aside>
      </div>
    </article>
  } @else {
    <div class="flex justify-center items-center min-h-[50vh]">
      <span class="loading loading-spinner loading-lg"></span>
    </div>
  }
</section>