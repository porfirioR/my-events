<section aria-labelledby="match-requests-heading" class="mb-8">
  <article class="dark:bg-base-300 rounded-xl transition-all duration-300">
    <header class="px-6 py-4 border-b border-base-300 dark:border-base-100">
      <div class="flex items-center justify-between flex-wrap gap-4">
        <div class="flex items-center gap-3">
          <button
            type="button"
            class="btn btn-sm btn-ghost btn-circle"
            [routerLink]="['/collaborators']"
          >
            <i class="fas fa-arrow-left" aria-hidden="true"></i>
          </button>
          <h2 id="match-requests-heading" class="text-xl font-semibold text-base-content">
            Match Requests
          </h2>
        </div>
        <div class="flex items-center gap-2 flex-wrap">
          <!-- Tabs -->
          <div class="btn-group">
            <button 
              type="button"
              class="btn btn-sm"
              [ngClass]="{'btn-active': activeTab === 'received'}"
              (click)="activeTab = 'received'"
            >
              <i class="fas fa-inbox mr-1" aria-hidden="true"></i>
              Received ({{ receivedRequests.length }})
            </button>
            <button 
              type="button"
              class="btn btn-sm"
              [ngClass]="{'btn-active': activeTab === 'sent'}"
              (click)="activeTab = 'sent'"
            >
              <i class="fas fa-paper-plane mr-1" aria-hidden="true"></i>
              Sent ({{ sentRequests.length }})
            </button>
          </div>

          <!-- Create New Button -->
          <button
            type="button"
            class="btn btn-sm btn-primary"
            (click)="activeTab = 'create'"
          >
            <i class="fas fa-plus mr-1" aria-hidden="true"></i>
            Create New
          </button>
        </div>
      </div>
    </header>

    <div class="p-6">
      @if (initialLoading()) {
        <div class="flex justify-center items-center py-12">
          <span class="loading loading-spinner loading-lg"></span>
          <p class="ml-3 text-base-content/70">Loading...</p>
        </div>
      } @else {
        <!-- Received Requests Tab -->
        @if (activeTab === 'received') {
          <div>
            <ul class="space-y-4" role="list">
              @for (request of receivedRequests; track request.id) {
                <li class="bg-base-100 dark:bg-base-200 rounded-lg p-4 hover:bg-base-300/50 dark:hover:bg-base-100/50 transition-colors duration-200">
                  <article class="flex items-center justify-between">
                    <div class="flex items-center gap-4 flex-grow">
                      <figure class="flex-shrink-0 w-12 h-12 rounded-full bg-primary/20 flex items-center justify-center text-primary font-semibold">
                        {{ request.requesterUserEmail.charAt(0).toUpperCase() }}
                      </figure>
                      <div class="flex-grow min-w-0">
                        <h3 class="font-semibold text-base-content">
                          {{ request.requesterUserEmail }}
                        </h3>
                        <p class="text-sm text-base-content/70">
                          Wants to match with: {{ request.targetCollaboratorEmail }}
                        </p>
                        <p class="text-xs text-base-content/60 mt-1">
                          They registered you as: <span class="font-medium">{{ request.requesterCollaboratorName }}</span>
                        </p>
                        <time [attr.datetime]="request.requestedDate" class="text-xs text-base-content/60 mt-1 block">
                          {{ getFormattedDate(request.requestedDate) }}
                        </time>
                      </div>
                    </div>

                    <button
                      type="button"
                      class="btn btn-sm btn-success"
                      (click)="acceptRequest(request)"
                    >
                      <i class="fas fa-check mr-1" aria-hidden="true"></i>
                      Accept
                    </button>
                  </article>
                </li>
              }

              <!-- Empty State -->
              @if (receivedRequests.length === 0) {
                <li class="text-center py-12">
                  <figure class="mx-auto w-16 h-16 bg-base-content/10 rounded-full flex items-center justify-center mb-4">
                    <i class="fas fa-inbox text-2xl text-base-content/50" aria-hidden="true"></i>
                  </figure>
                  <h3 class="text-lg font-medium text-base-content mb-2">No received requests</h3>
                  <p class="text-base-content/70">You don't have any pending match requests</p>
                </li>
              }
            </ul>
          </div>
        }

        <!-- Sent Requests Tab -->
        @if (activeTab === 'sent') {
          <div>
            <ul class="space-y-4" role="list">
              @for (request of sentRequests; track request.id) {
                <li class="bg-base-100 dark:bg-base-200 rounded-lg p-4 hover:bg-base-300/50 dark:hover:bg-base-100/50 transition-colors duration-200">
                  <article class="flex items-center justify-between">
                    <div class="flex items-center gap-4 flex-grow">
                      <figure class="flex-shrink-0 w-12 h-12 rounded-full bg-secondary/20 flex items-center justify-center text-secondary font-semibold">
                        {{ request.requesterCollaboratorName.charAt(0) }}{{ request.requesterCollaboratorSurname.charAt(0) }}
                      </figure>
                      <div class="flex-grow min-w-0">
                        <h3 class="font-semibold text-base-content truncate">
                          {{ request.requesterCollaboratorName }} {{ request.requesterCollaboratorSurname }}
                        </h3>
                        <p class="text-sm text-base-content/70">
                          Request to: {{ request.targetCollaboratorEmail }}
                        </p>
                        <div class="flex items-center gap-2 mt-1">
                          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border" 
                            [ngClass]="getStatusBadgeClass(request.status)">
                            {{ request.status }}
                          </span>
                          <time [attr.datetime]="request.requestedDate" class="text-xs text-base-content/60">
                            {{ getFormattedDate(request.requestedDate) }}
                          </time>
                        </div>
                      </div>
                    </div>

                    @if (request.status === 'Pending' || request.status === 'EmailNotFound') {
                      <button
                        type="button"
                        class="btn btn-sm btn-error btn-outline"
                        (click)="cancelRequest(request)"
                      >
                        <i class="fas fa-times mr-1" aria-hidden="true"></i>
                        Cancel
                      </button>
                    }
                  </article>
                </li>
              }

              <!-- Empty State -->
              @if (sentRequests.length === 0) {
                <li class="text-center py-12">
                  <figure class="mx-auto w-16 h-16 bg-base-content/10 rounded-full flex items-center justify-center mb-4">
                    <i class="fas fa-paper-plane text-2xl text-base-content/50" aria-hidden="true"></i>
                  </figure>
                  <h3 class="text-lg font-medium text-base-content mb-2">No sent requests</h3>
                  <p class="text-base-content/70 mb-4">You haven't sent any match requests yet</p>
                  <button class="btn btn-primary" (click)="activeTab = 'create'">
                    <i class="fas fa-plus mr-2" aria-hidden="true"></i>
                    Create Match Request
                  </button>
                </li>
              }
            </ul>
          </div>
        }

        <!-- Create New Request Tab -->
        @if (activeTab === 'create') {
          <div class="flex justify-center">
            <section class="max-w-3xl mx-auto bg-base-200 dark:bg-base-300 rounded-xl shadow-lg p-6 border-indigo-500 ring-indigo-500 ring-1">
              <main class="px-6 py-6 space-y-6">
                <h3 class="text-xl font-bold text-base-content">
                  Create Match Request
                </h3>

                <form [formGroup]="formGroup" (submit)="createMatchRequest()" class="space-y-6">
                  <div class="space-y-4">
                    <app-select-input
                      formControlName="collaboratorId"
                      id="collaboratorId"
                      label="Unlinked Collaborator"
                      name="collaborator"
                      [list]="internalCollaboratorList"
                      [disabled]="isLoading()"
                    />

                    <app-text
                      formControlName="targetEmail"
                      type="email"
                      placeholder="collaborator@example.com"
                      autocomplete="email"
                      label="Target Email"
                      id="targetEmail"
                      name="targetEmail"
                      [disabled]="isLoading()"
                    />
                  </div>

                  <div class="alert alert-info">
                    <i class="fas fa-info-circle" aria-hidden="true"></i>
                    <div>
                      <h4 class="font-semibold">About Match Requests</h4>
                      <p class="text-sm">
                        Only unlinked collaborators (without email) can send match requests. When accepted, your collaborator will be assigned this email and linked with the target user's collaborator. You can only send one invitation per email.
                      </p>
                    </div>
                  </div>

                  <footer class="flex justify-between items-center pt-6 gap-4">
                    <button
                      type="button"
                      class="btn btn-outline btn-primary flex items-center gap-2 transition-all duration-200 hover:scale-105"
                      [disabled]="isLoading()"
                      (click)="exit()"
                    >
                      <i class="fas fa-arrow-left text-sm"></i>
                      Cancel
                    </button>

                    @if (isLoading()) {
                      <button
                        type="button"
                        class="btn btn-primary flex items-center gap-2 loading-btn"
                      >
                        <span class="loading loading-spinner loading-xs"></span>
                        Saving...
                      </button>
                    } @else {
                      <button
                        role="button"
                        type="submit"
                        class="btn btn-primary flex items-center gap-2 transition-all duration-200 hover:scale-105"
                        [disabled]="formGroup.invalid"
                        [class.btn-disabled]="formGroup.invalid"
                      >
                        <i class="fas fa-cloud-arrow-up text-sm"></i>
                        Save
                      </button>
                    }
                  </footer>
                </form>
              </main>
            </section>
          </div>
        }
      }
    </div>
  </article>
</section>

<!-- Modal de Selección de Colaborador -->
@if (showCollaboratorSelectionModal) {
  <div class="modal modal-open">
    <div class="modal-box max-w-md">
      <h3 class="font-bold text-lg mb-4">Select a Collaborator</h3>

      <div class="alert alert-info mb-4">
        <i class="fas fa-info-circle"></i>
        <div class="text-sm">
          <p class="font-semibold">
            {{ pendingRequestToAccept?.requesterUserEmail }} wants to match with you
          </p>
          <p class="mt-2">
            They registered you as: 
            <strong>{{ pendingRequestToAccept?.requesterCollaboratorName }}</strong>
          </p>
          <p class="mt-2">
            Select one of your unlinked collaborators to assign the email 
            <strong>{{ pendingRequestToAccept?.requesterUserEmail }}</strong>
          </p>
        </div>
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Choose an Unlinked Collaborator</span>
        </label>
        <select 
          class="select select-bordered w-full"
          [(ngModel)]="selectedCollaboratorForAccept">
          <option [value]="null" disabled>-- Select a collaborator --</option>
          @for (collab of internalCollaboratorsForAcceptList; track collab.key) {
            <option [value]="collab.key">
              {{ collab.value }}
            </option>
          }
        </select>
        <div class="label">
          <span class="label-text-alt text-base-content/60">
            This collaborator will be assigned the email: 
            <strong>{{ pendingRequestToAccept?.requesterUserEmail }}</strong>
          </span>
        </div>
      </div>

      @if (internalCollaborators.length === 0) {
        <div class="alert alert-warning mt-4">
          <i class="fas fa-exclamation-triangle"></i>
          <span>You need to create an unlinked collaborator first.</span>
        </div>
      }

      <div class="modal-action">
        <button 
          class="btn btn-ghost" 
          (click)="cancelCollaboratorSelection()"
          [disabled]="isLoading()">
          Cancel
        </button>
        <button 
          class="btn btn-primary"
          [disabled]="!selectedCollaboratorForAccept || isLoading()"
          (click)="confirmAcceptWithCollaborator()">
          @if (isLoading()) {
            <span class="loading loading-spinner loading-xs"></span>
            Processing...
          } @else {
            <i class="fas fa-check mr-2"></i>
            Accept & Assign
          }
        </button>
      </div>
    </div>
  </div>
}