<section aria-labelledby="match-requests-heading" class="mb-8">
  <article class="dark:bg-base-300 rounded-xl transition-all duration-300">
    <header class="px-6 py-4 border-b border-base-300 dark:border-base-100">
      <div class="flex items-center justify-between flex-wrap gap-4">
        <div class="flex items-center gap-3">
          <a
            type="button"
            class="btn btn-sm btn-ghost btn-circle"
            [routerLink]="['/collaborators']"
          >
            <i class="fas fa-arrow-left" aria-hidden="true"></i>
          </a>
          <h2 id="match-requests-heading" class="text-xl font-semibold text-base-content">
            {{ 'matchRequests.title' | translate }}
          </h2>
        </div>
        <div class="flex items-center gap-2 flex-wrap">
          <!-- Tabs -->
          <div class="btn-group">
            <button 
              type="button"
              class="btn btn-sm"
              [ngClass]="{'btn-active': activeTab === 'received'}"
              (click)="activeTab = 'received'"
            >
              <i class="fas fa-inbox mr-1" aria-hidden="true"></i>
              {{ 'matchRequests.received' | translate }} ({{ receivedRequests.length }})
            </button>
            <button 
              type="button"
              class="btn btn-sm"
              [ngClass]="{'btn-active': activeTab === 'sent'}"
              (click)="activeTab = 'sent'"
            >
              <i class="fas fa-paper-plane mr-1" aria-hidden="true"></i>
              {{ 'matchRequests.sent' | translate }} ({{ sentRequests.length }})
            </button>
          </div>

          <!-- Create New Button -->
          <button
            type="button"
            class="btn btn-sm btn-primary"
            (click)="activeTab = 'create'"
          >
            <i class="fas fa-plus mr-1" aria-hidden="true"></i>
            {{ 'matchRequests.createNew' | translate }}
          </button>
        </div>
      </div>
    </header>

    <div class="p-6">
      @if (initialLoading()) {
        <div class="flex justify-center items-center py-12">
          <span class="loading loading-spinner loading-lg"></span>
          <p class="ml-3 text-base-content/70">{{ 'matchRequests.loading' | translate }}</p>
        </div>
      } @else {
        <!-- Received Requests Tab -->
        @if (activeTab === 'received') {
          <div>
            <ul class="space-y-4" role="list">
              @for (request of receivedRequests; track request.id) {
                <li class="bg-base-200 dark:bg-base-200 rounded-lg p-4 hover:bg-base-300/50 dark:hover:bg-base-100/50 transition-colors duration-200">
                  <article class="flex items-center justify-between">
                    <div class="flex items-center gap-4 flex-grow">
                      <figure class="hidden flex-shrink-0 w-12 h-12 rounded-full bg-primary/20 md:flex items-center justify-center text-primary font-semibold">
                        {{ request.requesterUserEmail.charAt(0).toUpperCase() }}
                      </figure>
                      <div class="flex-grow min-w-0">
                        <h3 class="font-semibold text-base-content">
                          {{ request.requesterUserEmail }}
                        </h3>
                        <p class="text-sm text-base-content/70">
                          {{ 'matchRequests.wantsToMatch' | translate }}
                          <span>
                            {{ request.targetCollaboratorEmail }}
                          </span>
                        </p>
                        <p class="text-xs text-base-content/60 mt-1">
                          {{ 'matchRequests.theyRegisteredYou' | translate }} <span class="font-medium">{{ request.requesterCollaboratorName }}</span>
                        </p>
                        <time [attr.datetime]="request.requestedDate" class="text-xs text-base-content/60 mt-1 block">
                          {{ getFormattedDate(request.requestedDate) }}
                        </time>
                      </div>
                    </div>

                    <button
                      type="button"
                      class="btn btn-sm btn-success"
                      (click)="acceptRequest(request)"
                    >
                      <i class="fas fa-check mr-1" aria-hidden="true"></i>
                      {{ 'matchRequests.accept' | translate }}
                    </button>
                  </article>
                </li>
              }

              <!-- Empty State -->
              @if (receivedRequests.length === 0) {
                <li class="text-center py-12">
                  <figure class="mx-auto w-16 h-16 bg-base-content/10 rounded-full flex items-center justify-center mb-4">
                    <i class="fas fa-inbox text-2xl text-base-content/50" aria-hidden="true"></i>
                  </figure>
                  <h3 class="text-lg font-medium text-base-content mb-2">{{ 'matchRequests.noReceivedRequests' | translate }}</h3>
                  <p class="text-base-content/70">{{ 'matchRequests.noPendingRequests' | translate }}</p>
                </li>
              }
            </ul>
          </div>
        }

        <!-- Sent Requests Tab -->
        @if (activeTab === 'sent') {
          <div>
            <ul class="space-y-4" role="list">
              @for (request of sentRequests; track request.id) {
                <li class="bg-base-100 dark:bg-base-200 rounded-lg p-4 hover:bg-base-300/50 dark:hover:bg-base-100/50 transition-colors duration-200">
                  <article class="flex items-center justify-between">
                    <div class="flex items-center gap-4 flex-grow">
                      <figure class="flex-shrink-0 w-12 h-12 rounded-full bg-secondary/20 flex items-center justify-center text-secondary font-semibold">
                        {{ request.requesterCollaboratorName.charAt(0) }}{{ request.requesterCollaboratorSurname.charAt(0) }}
                      </figure>
                      <div class="flex-grow min-w-0">
                        <h3 class="font-semibold text-base-content truncate">
                          {{ request.requesterCollaboratorName }} {{ request.requesterCollaboratorSurname }}
                        </h3>
                        <p class="text-sm text-base-content/70">
                          {{ 'matchRequests.requestTo' | translate }} {{ request.targetCollaboratorEmail }}
                        </p>
                        <div class="flex items-center gap-2 mt-1">
                          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border" 
                            [ngClass]="getStatusBadgeClass(request.status)">
                            {{ request.status | translate }}
                          </span>
                          <time [attr.datetime]="request.requestedDate" class="text-xs text-base-content/60">
                            {{ getFormattedDate(request.requestedDate) }}
                          </time>
                        </div>
                      </div>
                    </div>

                    @if (request.status === 'Pending' || request.status === 'EmailNotFound') {
                      <button
                        type="button"
                        class="btn btn-sm btn-error btn-outline"
                        (click)="cancelRequest(request)"
                      >
                        <i class="fas fa-times mr-1" aria-hidden="true"></i>
                        {{ 'matchRequests.cancel' | translate }}
                      </button>
                    }
                  </article>
                </li>
              }

              <!-- Empty State -->
              @if (sentRequests.length === 0) {
                <li class="text-center py-12">
                  <figure class="mx-auto w-16 h-16 bg-base-content/10 rounded-full flex items-center justify-center mb-4">
                    <i class="fas fa-paper-plane text-2xl text-base-content/50" aria-hidden="true"></i>
                  </figure>
                  <h3 class="text-lg font-medium text-base-content mb-2">{{ 'matchRequests.noSentRequests' | translate }}</h3>
                  <p class="text-base-content/70 mb-4">{{ 'matchRequests.haventSentAny' | translate }}</p>
                  <button class="btn btn-primary" (click)="activeTab = 'create'">
                    <i class="fas fa-plus mr-2" aria-hidden="true"></i>
                    {{ 'matchRequests.createMatchRequest' | translate }}
                  </button>
                </li>
              }
            </ul>
          </div>
        }

        <!-- Create New Request Tab -->
        @if (activeTab === 'create') {
          <div class="flex justify-center">
            <section class="max-w-3xl mx-auto bg-base-200 dark:bg-base-300 rounded-xl shadow-lg p-6 border-indigo-500 ring-indigo-500 ring-1">
              <main class="px-6 py-6 space-y-6">
                <h3 class="text-xl font-bold text-base-content">
                  {{ 'matchRequests.createMatchRequest' | translate }}
                </h3>

                <form [formGroup]="formGroup" (submit)="createMatchRequest()" class="space-y-6">
                  <div class="space-y-4">
                    <app-select-input
                      formControlName="collaboratorId"
                      id="collaboratorId"
                      label="Unlinked Collaborator"
                      name="collaborator"
                      [list]="internalCollaborators()"
                      [disabled]="isLoading()"
                    />

                    <app-text
                      formControlName="targetEmail"
                      type="email"
                      placeholder="collaborator@example.com"
                      autocomplete="email"
                      label="Target Email"
                      id="targetEmail"
                      name="targetEmail"
                      [disabled]="isLoading()"
                    />
                  </div>

                  <div class="alert alert-info alert-soft">
                    <i class="fas fa-info-circle" aria-hidden="true"></i>
                    <div>
                      <h4 class="font-semibold">{{ 'matchRequests.aboutMatchRequests' | translate }}</h4>
                      <p class="text-sm">
                        {{ 'matchRequests.aboutMatchRequestsDescription' | translate }}
                      </p>
                    </div>
                  </div>

                  <footer class="flex justify-between items-center pt-6 gap-4">
                    <button
                      type="button"
                      class="btn btn-outline btn-primary flex items-center gap-2 transition-all duration-200 hover:scale-105"
                      [disabled]="isLoading()"
                      (click)="exit()"
                    >
                      <i class="fas fa-arrow-left text-sm"></i>
                      {{ 'matchRequests.cancel' | translate }}
                    </button>

                    @if (isLoading()) {
                      <button
                        type="button"
                        class="btn btn-primary flex items-center gap-2 loading-btn"
                      >
                        <span class="loading loading-spinner loading-xs"></span>
                        {{ 'matchRequests.saving' | translate }}
                      </button>
                    } @else {
                      <button
                        role="button"
                        type="submit"
                        class="btn btn-primary flex items-center gap-2 transition-all duration-200 hover:scale-105"
                        [disabled]="formGroup.invalid"
                        [class.btn-disabled]="formGroup.invalid"
                      >
                        <i class="fas fa-cloud-arrow-up text-sm"></i>
                        {{ 'matchRequests.save' | translate }}
                      </button>
                    }
                  </footer>
                </form>
              </main>
            </section>
          </div>
        }
      }
    </div>
  </article>
</section>

<!-- Modal de SelecciÃ³n de Colaborador -->
@if (showCollaboratorSelectionModal) {
  <div class="modal modal-open">
    <div class="modal-box max-w-md">
      <h3 class="font-bold text-lg mb-4">
        {{ 'matchRequests.selectCollaborator' | translate }}
      </h3>

      <div class="alert alert-info alert-soft mb-4">
        <i class="fas fa-info-circle"></i>
        <div class="text-sm">
          <p class="font-semibold">
            {{ 'matchRequests.wantsToMatchWithYou' | translate:{ email: pendingRequestToAccept?.requesterUserEmail } }}
          </p>
          <p class="mt-2">
            {{ 'matchRequests.theyRegisteredYou' | translate }}
          </p>
          <p class="text-dark">
            {{ pendingRequestToAccept?.requesterCollaboratorName }}
          </p>
          <p class="mt-2">
            {{ 'matchRequests.selectUnlinkedCollaborator' | translate }} 
            <strong>{{ pendingRequestToAccept?.requesterUserEmail }}</strong>
          </p>
        </div>
      </div>
      <form [formGroup]="formGroup">
        <app-select-input
          formControlName="collaboratorId"
          id="collaboratorId"
          label="Collaborator"
          name="collaborator"
          [list]="internalCollaborators()"
          [disabled]="isLoading()"
        />
        <div class="text-ellipsis">
          <span class="label-text-alt text-base-content/60">
            {{ 'matchRequests.willBeAssignedEmail' | translate }} 
            <strong>{{ pendingRequestToAccept?.requesterUserEmail }}</strong>
          </span>
        </div>
      </form>
      @if (internalCollaborators().length === 0) {
        <div class="alert alert-warning alert-soft mt-4">
          <i class="fas fa-exclamation-triangle"></i>
          <span>{{ 'matchRequests.needUnlinkedCollaborator' | translate }}</span>
        </div>
      }

      <footer class="modal-action flex justify-between items-center pt-6 gap-4">
        <button
          class="btn btn-outline btn-primary flex items-center gap-2 transition-all duration-200 hover:scale-105"
          (click)="cancelCollaboratorSelection()"
          [disabled]="isLoading()"
        >
          <i class="fas fa-arrow-left text-sm"></i>
          {{ 'matchRequests.cancel' | translate }}
        </button>
        <button 
          class="btn btn-primary"
          [disabled]="!formGroup.value.collaboratorId || isLoading()"
          (click)="confirmAcceptWithCollaborator()">
          @if (isLoading()) {
            <span class="loading loading-spinner loading-xs"></span>
            {{ 'matchRequests.processing' | translate }}
          } @else {
            <i class="fas fa-check mr-2"></i>
            {{ 'matchRequests.acceptAndAssign' | translate }}
          }
        </button>
      </footer>
    </div>
  </div>
}