<section class="container mx-auto px-4 py-8">
  <article class="max-w-3xl mx-auto bg-base-200 dark:bg-base-300 rounded-xl shadow-lg p-6 border-indigo-500 ring-indigo-500 ring-1">
    <header class="mb-6">
      <div class="flex items-center justify-between">
        <button
          type="button"
          class="btn btn-sm btn-ghost btn-circle"
          [routerLink]="['/transactions']"
        >
          <i class="fas fa-arrow-left" aria-hidden="true"></i>
        </button>
        <h1 class="text-xl font-bold leading-tight tracking-tight text-base-content md:text-2xl transition-colors duration-300">
          {{ isEditMode ? ('upsertTransaction.editTitle' | translate) : ('upsertTransaction.newTitle' | translate) }}
        </h1>
        <button type="button" class="btn btn-ghost btn-sm btn-circle" (click)="goBack()">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </header>

    <form [formGroup]="formGroup" (ngSubmit)="onSubmit()">
      <app-select-input
        formControlName="collaboratorId"
        id="collaboratorId"
        [label]="'upsertTransaction.collaborator' | translate"
        name="collaborator"
        [list]="linkedCollaborators()"
        [disabled]="isLoading()"
      />

      <app-text
        formControlName="totalAmount"
        type="number"
        [label]="'upsertTransaction.totalAmount' | translate"
        id="totalAmount"
        name="totalAmount"
        [description]="'upsertTransaction.totalAmountDescription' | translate"
      />
      <app-text-area-input
        formControlName="description"
        [label]="'upsertTransaction.description' | translate"
        id="description"
        name="description"
        [placeholder]="'upsertTransaction.descriptionPlaceholder' | translate"
      />

      <!-- Reimbursement Section -->
      <app-check-box-input
        formControlName="hasReimbursement"
        id="hasReimbursement"
        [label]="'upsertTransaction.addReimbursement' | translate"
      />

      @if (formGroup.controls.hasReimbursement.value) {
        <div class="bg-base-100 dark:bg-base-200 rounded-lg p-4 mb-4" formGroupName="reimbursement">
          <h3 class="text-lg font-semibold mb-3">{{ 'upsertTransaction.reimbursementDetails' | translate }}</h3>
          <app-text 
            formControlName="amount" 
            type="number" 
            [label]="'upsertTransaction.amount' | translate"
            id="amount" 
            name="amount" 
          />
          <app-text-area-input 
            formControlName="description" 
            [label]="'upsertTransaction.description' | translate"
            id="description" 
            name="description" 
          />
          <div class="alert alert-info alert-soft mt-3">
            <i class="fas fa-info-circle"></i>
            <span>{{ 'upsertTransaction.netAmountAfterReimbursement' | translate: { amount: formatCurrency(calculateNetAmount()) } }}</span>
          </div>
        </div>
      }
      
      <!-- Who Paid -->
      <section class="flex flex-col md:flex-row md:gap-4">
        <div class="form-control mb-4 md:flex-1">
          <label class="label">
            <span class="label-text">{{ 'upsertTransaction.whoPaid' | translate }}</span>
          </label>
          <div class="btn-group w-full">
            <button 
              type="button"
              class="btn flex-1"
              [ngClass]="{'btn-active': formGroup.get('whoPaid')?.value === whoPaid.User}"
              (click)="setWhoPaid(whoPaid.User)"
            >
              <i class="fas fa-user mr-2"></i>
              {{ 'upsertTransaction.iPaid' | translate }}
            </button>
            <button 
              type="button"
              class="btn flex-1"
              [ngClass]="{'btn-active': formGroup.get('whoPaid')?.value === whoPaid.Collaborator}"
              (click)="setWhoPaid(whoPaid.Collaborator)"
            >
              <i class="fas fa-user-friends mr-2"></i>
              {{ 'upsertTransaction.theyPaid' | translate }}
            </button>
          </div>
        </div>

        <!-- Split Type -->
        <div class="form-control mb-4 md:flex-1">
          <label class="label">
            <span class="label-text">{{ 'upsertTransaction.splitType' | translate }}</span>
          </label>
          <div class="btn-group w-full">
            <button 
              type="button"
              class="btn btn-sm flex-1"
              [ngClass]="{'btn-active': formGroup.value.splitType === splitType.Equal}"
              (click)="setSplitType(splitType.Equal)"
            >
              <i class="fas fa-equals mr-1"></i>
              {{ 'upsertTransaction.equal' | translate }}
            </button>
            <button 
              type="button"
              class="btn btn-sm flex-1"
              [ngClass]="{'btn-active': formGroup.value.splitType === splitType.Custom}"
              (click)="setSplitType(splitType.Custom)"
            >
              <i class="fas fa-sliders-h mr-1"></i>
              {{ 'upsertTransaction.custom' | translate }}
            </button>
            <button 
              type="button"
              class="btn btn-sm flex-1"
              [ngClass]="{'btn-active': formGroup.value.splitType === splitType.Percentage}"
              (click)="setSplitType(splitType.Percentage)"
            >
              <i class="fas fa-percent mr-1"></i>
              {{ 'upsertTransaction.percentage' | translate }}
            </button>
          </div>
        </div>
      </section>

      <!-- Split Details -->
      @if (formGroup.controls.totalAmount.value && formGroup.controls.totalAmount.value > 0) {
        <div class="bg-base-100 dark:bg-base-200 rounded-lg p-4 mb-4">
          <h3 class="text-lg font-semibold mb-3">{{ 'upsertTransaction.splitDetails' | translate }}</h3>

          <!-- Equal Split - Solo mostrar resultado -->
          @if (formGroup.value.splitType === splitType.Equal) {
            <div class="space-y-3">
              <div class="alert alert-info alert-soft">
                <i class="fas fa-info-circle"></i>
                <span class="text-sm">{{ 'upsertTransaction.equalSplitInfo' | translate }}</span>
              </div>
            </div>
          }

          <!-- Custom Split -->
          @if (formGroup.value.splitType === splitType.Custom) {
            <div class="space-y-4">
              <!-- Explicación contextual -->
              <div class="alert alert-info alert-soft text-xs">
                <i class="fas fa-info-circle"></i>
                <span>
                  @if (formGroup.value.whoPaid === whoPaid.User) {
                    {{ 'upsertTransaction.youPaidFullAmount' | translate }}
                  } @else {
                    {{ 'upsertTransaction.theyPaidFullAmount' | translate }}
                  }
                </span>
              </div>

              <div class="form-control">
                <label class="label">
                  <span class="label-text font-medium">
                    @if (formGroup.value.whoPaid === whoPaid.User) {
                      <i class="fas fa-arrow-left text-success mr-1"></i>
                      <i class="fas fa-user-friends text-primary mr-1"></i>
                      {{ 'upsertTransaction.theirPortionExpense' | translate }}
                    } @else {
                      <i class="fas fa-arrow-right text-error mr-1"></i>
                      <i class="fas fa-user text-primary mr-1"></i>
                      {{ 'upsertTransaction.yourPortionExpense' | translate }}
                    }
                  </span>
                  <span class="label-text-alt text-xs text-base-content/60">
                    @if (formGroup.value.whoPaid === whoPaid.User) {
                      {{ 'upsertTransaction.theyWillOweYou' | translate }}
                    } @else {
                      {{ 'upsertTransaction.youWillOweThem' | translate }}
                    }
                  </span>
                </label>
                <input
                  type="number"
                  class="px-3 py-2 border shadow-sm border-slate-300 placeholder-slate-400 disabled:bg-slate-50 disabled:text-slate-500 disabled:border-slate-200 focus:outline-none focus:border-indigo-500 focus:ring-indigo-500 block w-full rounded-md sm:text-sm focus:ring-1 transition-colors duration-200 dark:bg-gray-800 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-indigo-500 dark:focus:border-indigo-500"
                  [value]="customUserAmount()"
                  (input)="onCustomUserAmountChange($event)"
                  [min]="0"
                  [max]="calculateNetAmount()"
                  [step]="1"
                  [placeholder]="'upsertTransaction.enterAmount' | translate"
                >
              </div>

              <div class="form-control">
                <label class="label">
                  <span class="label-text font-medium">
                    @if (formGroup.value.whoPaid === whoPaid.User) {
                      <i class="fas fa-user text-primary mr-1"></i>
                      {{ 'upsertTransaction.yourPortionExpense' | translate }}
                    } @else {
                      <i class="fas fa-user-friends text-primary mr-1"></i>
                      {{ 'upsertTransaction.theirPortionExpense' | translate }}
                    }
                  </span>
                  <span class="label-text-alt text-xs text-base-content/60">
                    @if (formGroup.value.whoPaid === whoPaid.User) {
                      {{ 'upsertTransaction.yourShareAlreadyPaid' | translate }}
                    } @else {
                      {{ 'upsertTransaction.theirShareAlreadyPaid' | translate }}
                    }
                  </span>
                </label>
                <input
                  type="number"
                  class="px-3 py-2 border shadow-sm border-slate-300 placeholder-slate-400 disabled:bg-slate-50 disabled:text-slate-500 disabled:border-slate-200 focus:outline-none focus:border-indigo-500 focus:ring-indigo-500 block w-full rounded-md sm:text-sm focus:ring-1 transition-colors duration-200 dark:bg-gray-800 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-indigo-500 dark:focus:border-indigo-500" 
                  [value]="customCollaboratorAmount()"
                  (input)="onCustomCollaboratorAmountChange($event)"
                  [min]="0"
                  [max]="calculateNetAmount()"
                  [step]="1"
                  [placeholder]="'upsertTransaction.enterAmount' | translate"
                >
              </div>
            </div>
          }

          <!-- Percentage Split -->
          @if (formGroup.value.splitType === splitType.Percentage) {
            <div class="space-y-4">
              <!-- Explicación contextual -->
              <div class="alert alert-info alert-soft text-xs">
                <i class="fas fa-info-circle"></i>
                <span>
                  @if (formGroup.value.whoPaid === whoPaid.User) {
                    {{ 'upsertTransaction.youPaidFullPercentage' | translate }}
                  } @else {
                    {{ 'upsertTransaction.theyPaidFullPercentage' | translate }}
                  }
                </span>
              </div>

              <div class="form-control">
                <label class="label">
                  <span class="label-text font-medium">
                    @if (formGroup.value.whoPaid === whoPaid.User) {
                      <i class="fas fa-arrow-left text-success mr-1"></i>
                      <i class="fas fa-user-friends text-primary mr-1"></i>
                      {{ 'upsertTransaction.theirPortionPercentage' | translate }}
                    } @else {
                      <i class="fas fa-arrow-right text-error mr-1"></i>
                      <i class="fas fa-user text-primary mr-1"></i>
                      {{ 'upsertTransaction.yourPortionPercentage' | translate }}
                    }
                  </span>
                  <span class="label-text-alt text-xs text-base-content/60">
                    @if (formGroup.value.whoPaid === whoPaid.User) {
                      {{ 'upsertTransaction.theyWillOwePercentage' | translate }}
                    } @else {
                      {{ 'upsertTransaction.youWillOwePercentage' | translate }}
                    }
                  </span>
                </label>
                <div class="join w-full">
                  <input
                    type="number"
                    class="px-3 py-2 border shadow-sm border-slate-300 placeholder-slate-400 disabled:bg-slate-50 disabled:text-slate-500 disabled:border-slate-200 focus:outline-none focus:border-indigo-500 focus:ring-indigo-500 block w-full rounded-md sm:text-sm focus:ring-1 transition-colors duration-200 dark:bg-gray-800 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-indigo-500 dark:focus:border-indigo-500 join-item flex-1"
                    [value]="customUserAmount()"
                    (input)="onCustomUserAmountChange($event)"
                    [min]="0"
                    [max]="100"
                    [step]="1"
                    placeholder="0"
                  >
                  <span class="btn btn-ghost join-item">%</span>
                </div>
              </div>

              <div class="form-control">
                <label class="label">
                  <span class="label-text font-medium">
                    @if (formGroup.value.whoPaid === whoPaid.User) {
                      <i class="fas fa-user text-primary mr-1"></i>
                      {{ 'upsertTransaction.yourPortionPercentage' | translate }}
                    } @else {
                      <i class="fas fa-user-friends text-primary mr-1"></i>
                      {{ 'upsertTransaction.theirPortionPercentage' | translate }}
                    }
                  </span>
                  <span class="label-text-alt text-xs text-base-content/60">
                    @if (formGroup.value.whoPaid === whoPaid.User) {
                      {{ 'upsertTransaction.yourShareAlreadyPaid' | translate }}
                    } @else {
                      {{ 'upsertTransaction.theirShareAlreadyPaid' | translate }}
                    }
                  </span>
                </label>
                <div class="join w-full">
                  <input
                    type="number"
                    class="px-3 py-2 border shadow-sm border-slate-300 placeholder-slate-400 disabled:bg-slate-50 disabled:text-slate-500 disabled:border-slate-200 focus:outline-none focus:border-indigo-500 focus:ring-indigo-500 block w-full rounded-md sm:text-sm focus:ring-1 transition-colors duration-200 dark:bg-gray-800 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-indigo-500 dark:focus:border-indigo-500 join-item flex-1" 
                    [value]="customCollaboratorAmount()"
                    (input)="onCustomCollaboratorAmountChange($event)"
                    [min]="0"
                    [max]="100"
                    [step]="1"
                    placeholder="0"
                  >
                  <span class="btn btn-ghost join-item">%</span>
                </div>
              </div>
            </div>
          }

          <!-- Split Summary - Mejorado con información de deudas -->
          <div class="bg-base-200 dark:bg-base-300 rounded-lg p-4 mt-4">
            <h4 class="text-sm font-semibold text-base-content/70 mb-3">{{ 'upsertTransaction.divisionBreakdown' | translate }}</h4>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between items-center">
                <span class="text-base-content/70">{{ 'upsertTransaction.yourShare' | translate }}</span>
                <span class="font-semibold">
                  {{ formatCurrency(calculateMySplit()) }}
                  @if (formGroup.value.splitType === splitType.Percentage) {
                    <span class="text-xs text-base-content/60 ml-1">({{ customUserAmount() }}%)</span>
                  }
                </span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-base-content/70">{{ 'upsertTransaction.theirShare' | translate }}</span>
                <span class="font-semibold">
                  {{ formatCurrency(calculateTheirSplit()) }}
                  @if (formGroup.value.splitType === splitType.Percentage) {
                    <span class="text-xs text-base-content/60 ml-1">({{ customCollaboratorAmount() }}%)</span>
                  }
                </span>
              </div>
              
              <div class="divider my-2"></div>
              
              <!-- Debt Information -->
              <div class="bg-base-100 dark:bg-base-200 rounded p-3 space-y-2">
                <div class="flex justify-between items-center">
                  <span class="text-base-content/70 flex items-center gap-1">
                    <i class="fas fa-arrow-right text-error text-xs"></i>
                    {{ 'upsertTransaction.youOweThem' | translate }}
                  </span>
                  <span class="font-bold" [class.text-error]="calculateMyDebt() > 0">
                    {{ formatCurrency(calculateMyDebt()) }}
                  </span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-base-content/70 flex items-center gap-1">
                    <i class="fas fa-arrow-left text-success text-xs"></i>
                    {{ 'upsertTransaction.theyOweYou' | translate }}
                  </span>
                  <span class="font-bold" [class.text-success]="calculateTheirDebt() > 0">
                    {{ formatCurrency(calculateTheirDebt()) }}
                  </span>
                </div>
              </div>

              <div class="divider my-2"></div>

              <div class="flex justify-between items-center text-base font-bold">
                <span>{{ 'upsertTransaction.netBalance' | translate }}</span>
                <span 
                  [class.text-error]="calculateNetBalance() < 0" 
                  [class.text-success]="calculateNetBalance() > 0"
                  [class.text-base-content]="calculateNetBalance() === 0"
                >
                  {{ getBalanceMessage() }}
                </span>
              </div>
            </div>
          </div>
        </div>
      }

      <!-- Transaction Summary Card -->
      @if (formGroup.controls.totalAmount.value && formGroup.controls.totalAmount.value > 0) {
        <div class="bg-base-100 dark:bg-base-200 rounded-lg p-4 mb-4">
          <h4 class="text-sm font-semibold text-base-content/70 mb-3 flex items-center gap-2">
            <i class="fas fa-receipt"></i>
            {{ 'upsertTransaction.transactionSummary' | translate }}
          </h4>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-base-content/70">{{ 'upsertTransaction.totalAmount' | translate }}</span>
              <span class="font-semibold">{{ formatCurrency(formGroup.value.totalAmount || 0) }}</span>
            </div>
            @if (formGroup.value.hasReimbursement && formGroup.value.reimbursement?.amount) {
              <div class="flex justify-between text-warning">
                <span>
                  <i class="fas fa-minus-circle mr-1"></i>
                  {{ 'upsertTransaction.reimbursement' | translate }}
                </span>
                <span class="font-semibold">-{{ formatCurrency(formGroup.value.reimbursement?.amount || 0) }}</span>
              </div>
            }
            <div class="divider my-1"></div>
            <div class="flex justify-between font-bold text-base">
              <span>{{ 'upsertTransaction.amountToSplit' | translate }}</span>
              <span>{{ formatCurrency(calculateNetAmount()) }}</span>
            </div>
            
            <!-- Contextual Alert -->
            <div class="mt-3">
              @if (formGroup.value.whoPaid === whoPaid.User) {
                <div class="alert alert-success alert-soft py-2 text-xs">
                  <i class="fas fa-check-circle"></i>
                  <div class="flex flex-col">
                    <span class="font-semibold">{{ 'upsertTransaction.youPaidAmount' | translate: { amount: formatCurrency(formGroup.value.totalAmount || 0) } }}</span>
                    <span class="text-xs opacity-80">{{ 'upsertTransaction.theyOweYouAmount' | translate: { amount: formatCurrency(calculateTheirDebt()) } }}</span>
                  </div>
                </div>
              } @else {
                <div class="alert alert-warning alert-soft py-2 text-xs">
                  <i class="fas fa-exclamation-circle"></i>
                  <div class="flex flex-col">
                    <span class="font-semibold">{{ 'upsertTransaction.theyPaidAmount' | translate: { amount: formatCurrency(formGroup.value.totalAmount || 0) } }}</span>
                    <span class="text-xs opacity-80">{{ 'upsertTransaction.youOweThemAmount' | translate: { amount: formatCurrency(calculateMyDebt()) } }}</span>
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      }

      <!-- Error Message -->
      @if (errorMessage()) {
        <div class="alert alert-error alert-soft mb-4">
          <i class="fas fa-exclamation-circle"></i>
          <span>{{ errorMessage() }}</span>
        </div>
      }

      <!-- Action Buttons -->
      <footer class="flex justify-between items-center pt-6 gap-4">
        <button
          type="button"
          class="btn btn-outline btn-primary flex items-center gap-2 transition-all duration-200 hover:scale-105"
          [disabled]="isLoading()"
          (click)="goBack()"
        >
          <i class="fas fa-arrow-left text-sm"></i>
          {{ 'upsertTransaction.cancel' | translate }}
        </button>
        @if (isSubmitting()) {
          <button
            type="button"
            class="btn btn-primary flex items-center gap-2 loading-btn"
          >
            <span class="loading loading-spinner loading-xs"></span>
            {{ 'upsertTransaction.saving' | translate }}
          </button>
        } @else {
          <button
            role="button"
            type="submit"
            class="btn btn-primary flex items-center gap-2 transition-all duration-200 hover:scale-105"
            [disabled]="formGroup.invalid || isSubmitting()"
            [class.btn-disabled]="formGroup.invalid || isSubmitting()"
          >
            <i class="fas fa-cloud-arrow-up text-sm"></i>
            {{ 'upsertTransaction.save' | translate }}
          </button>
        }
      </footer>
    </form>
  </article>
</section>