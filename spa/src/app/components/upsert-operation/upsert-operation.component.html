<!-- templates/upsert-operation.component.html -->
<section class="container mx-auto px-4 py-8">
  <article class="max-w-3xl mx-auto bg-base-200 dark:bg-base-300 rounded-xl shadow-lg p-8">
    <header class="mb-6">
      <div class="flex items-center justify-between">
        <button
          type="button"
          class="btn btn-sm btn-ghost btn-circle"
          [routerLink]="['/travels']"
        >
          <i class="fas fa-arrow-left" aria-hidden="true"></i>
        </button>
        <h1 class="text-xl font-bold leading-tight tracking-tight text-base-content md:text-2xl transition-colors duration-300">
          {{ isEditMode() ? ('operations.editTitle' | translate) : ('operations.newTitle' | translate) }}
        </h1>
        @if (travel(); as travelData) {
          <p class="text-base-content/70 mt-2">
            <i class="fas fa-plane-departure mr-2"></i>
            {{ travelData.name }}
          </p>
        }
        <button type="button" class="btn btn-ghost btn-sm btn-circle" (click)="goBack()">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </header>

    <form [formGroup]="formGroup" (ngSubmit)="save()">
      <!-- Category Selector -->
      <div class="mb-4">
        <app-category-selector
          [selectedCategoryId]="formGroup.value.categoryId || undefined"
          [disabled]="isLoading()"
          [required]="true"
          (categorySelected)="onCategorySelected($event)"
        />
      </div>

      <!-- Currency & Payment Method -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <app-select-input
          id="currencyId"
          name="currencyId"
          formControlName="currencyId"
          [label]="'operations.currency' | translate"
          [list]="currencyList()"
          [required]="true"
        />

        <app-select-input
          id="paymentMethodId"
          name="paymentMethodId"
          formControlName="paymentMethodId"
          [label]="'operations.paymentMethod' | translate"
          [list]="paymentMethodList()"
          [required]="true"
        />
      </div>

      <!-- Amount & Date -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <app-text
          id="amount"
          name="amount"
          formControlName="amount" 
          type="number" 
          [label]="'operations.amount' | translate"
          [placeholder]="'operations.enterAmount' | translate"
          [required]="true"
        />

        <app-date-input
          id="transactionDate"
          name="transactionDate"
          formControlName="transactionDate" 
          [label]="'operations.transactionDate' | translate"
          [required]="true"
        />
      </div>

      <!-- Description -->
      <div class="mb-4">
        <app-text-area-input
          id="description"
          name="description"
          formControlName="description"
          [label]="'operations.description' | translate"
          [placeholder]="'operations.descriptionPlaceholder' | translate"
          [required]="true"
        />
      </div>

      <!-- File Upload -->
      <div class="mb-4">
        <app-file-upload
          [disabled]="isLoading()"
          [required]="false"
          (fileSelected)="onFileSelected($event)"
        />
      </div>

      <!-- Who Paid -->
      <div class="mb-4">
        <app-select-input
          id="whoPaidMemberId"
          name="whoPaidMemberId"
          formControlName="whoPaidMemberId"
          [label]="'operations.whoPaid' | translate"
          [list]="memberList()"
          [required]="true"
        />
      </div>

      <div class="mb-4">
        <app-select-input
          id="participantType"
          name="participantType"
          formControlName="participantType"
          [label]="'operations.participantType' | translate"
          [list]="participantTypeList"
          (ngModelChange)="onParticipantTypeChange()"
        />
      </div>

            <!-- âœ… ACTUALIZADO: Participants Selection (solo si es Selected) -->
      @if (formGroup.value.participantType === 'Selected') {
        <div class="mb-4">
          <label class="block text-sm font-medium text-base-content mb-3">
            {{ 'operations.selectParticipants' | translate }}
            <span class="text-error">*</span>
          </label>
          <div class="bg-base-100 dark:bg-base-200 rounded-lg p-4">
            @if (members().length > 0) {
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                @for (member of members(); track member.id) {
                  <label class="flex items-center gap-3 p-3 rounded-lg cursor-pointer hover:bg-base-300/50 dark:hover:bg-base-100/50 transition-colors"
                    [class.bg-primary/10]="isParticipantSelected(member.id)"
                    [class.border-primary]="isParticipantSelected(member.id)"
                    [class.border-2]="isParticipantSelected(member.id)">
                    <input
                      type="checkbox"
                      class="checkbox checkbox-primary"
                      [checked]="isParticipantSelected(member.id)"
                      (change)="toggleParticipant(member.id)"
                    />
                    <div class="flex items-center gap-2 flex-grow">
                      <div class="w-8 h-8 rounded-full bg-primary text-primary-content flex items-center justify-center text-xs font-semibold">
                        {{ member.collaboratorName.charAt(0) }}{{ member.collaboratorSurname.charAt(0) }}
                      </div>
                      <span class="text-sm font-medium text-base-content">
                        {{ member.collaboratorName }} {{ member.collaboratorSurname }}
                      </span>
                    </div>
                  </label>
                }
              </div>
            } @else {
              <div class="text-center py-8">
                <p class="text-base-content/70 mb-4">{{ 'operations.noMembersAvailable' | translate }}</p>
              </div>
            }
          </div>
          @if (formGroup.controls.participantMemberIds.invalid && formGroup.controls.participantMemberIds.touched) {
            <span class="text-error text-sm mt-1 block">
              {{ 'operations.participantsRequired' | translate }}
            </span>
          }
        </div>
      }

      <!-- Split Type -->
      <div class="mb-4">
        <app-select-input
          id="splitType"
          name="splitType"
          formControlName="splitType"
          [label]="'operations.splitType' | translate"
          [list]="splitTypeList"
        />
      </div>

      <!-- Participants Selection -->
            @if ((formGroup.value.splitType === 'Custom' || formGroup.value.splitType === 'Percentage') && customSplitParticipants().length > 0) {
        <div class="mb-4">
          <label class="block text-sm font-medium text-base-content mb-3">
            @if (formGroup.value.splitType === 'Custom') {
              {{ 'operations.customAmounts' | translate }}
            } @else {
              {{ 'operations.customPercentages' | translate }}
            }
            <span class="text-error">*</span>
          </label>

          <div class="bg-base-100 dark:bg-base-200 rounded-lg p-4 space-y-3">
            @for (participant of customSplitParticipants(); track participant.memberId) {
              <div class="flex items-center gap-4 p-3 rounded-lg bg-base-50">
                <!-- Member Info -->
                <div class="flex items-center gap-2 flex-1">
                  <div class="w-8 h-8 rounded-full bg-primary text-primary-content flex items-center justify-center text-xs font-semibold">
                    {{ participant.memberName.split(' ')[0]?.charAt(0) }}{{ participant.memberName.split(' ')[1]?.charAt(0) }}
                  </div>
                  <span class="text-sm font-medium">{{ participant.memberName }}</span>
                </div>

                <!-- Custom Input -->
                <div class="flex items-center gap-2">
                  @if (formGroup.value.splitType === 'Custom') {
                    <span class="text-sm text-base-content/70">$</span>
                    <input
                      type="number"
                      class="input input-sm w-24 text-right"
                      [value]="participant.amount || 0"
                      (input)="onCustomAmountChange(participant.memberId, $event)"
                      step="0.01"
                      min="0"
                      [disabled]="isLoading()"
                    />
                  } @else {
                    <input
                      type="number"
                      class="input input-sm w-20 text-right"
                      [value]="participant.percentage || 0"
                      (input)="onCustomPercentageChange(participant.memberId, $event)"
                      step="1"
                      min="0"
                      max="100"
                      [disabled]="isLoading()"
                    />
                    <span class="text-sm text-base-content/70">%</span>
                  }
                </div>
              </div>
            }

            <!-- Validation Summary -->
            <div class="mt-4 p-3 rounded-lg border" 
                [class.border-success]="splitSummary().isValid" 
                [class.border-error]="!splitSummary().isValid"
                [class.bg-success/5]="splitSummary().isValid"
                [class.bg-error/5]="!splitSummary().isValid">
              
              @if (formGroup.value.splitType === 'Custom') {
                <div class="flex justify-between items-center text-sm">
                  <span>{{ 'operations.totalAssigned' | translate }}:</span>
                  <span [class.text-success]="splitSummary().isValid" [class.text-error]="!splitSummary().isValid">
                    {{ formatCurrency(splitSummary().totalAssigned || 0, formGroup.value.currencyId) }}
                  </span>
                </div>
                <div class="flex justify-between items-center text-sm">
                  <span>{{ 'operations.operationAmount' | translate }}:</span>
                  <span>{{ formatCurrency(formGroup.value.amount || 0, formGroup.value.currencyId) }}</span>
                </div>
                @if (!splitSummary().isValid) {
                  <div class="text-error text-sm mt-2">
                    {{ 'operations.customAmountsMustEqualTotal' | translate }}
                  </div>
                }
              }

              @if (formGroup.value.splitType === 'Percentage') {
                <div class="flex justify-between items-center text-sm">
                  <span>{{ 'operations.totalPercentage' | translate }}:</span>
                  <span [class.text-success]="splitSummary().isValid" [class.text-error]="!splitSummary().isValid">
                    {{ splitSummary().totalPercentage || 0 }}%
                  </span>
                </div>
                @if (!splitSummary().isValid) {
                  <div class="text-error text-sm mt-2">
                    {{ 'operations.percentagesMustEqual100' | translate }}
                  </div>
                }
              }
            </div>
          </div>
        </div>
      }

      <!-- Summary Card -->
      @if (formGroup.value.amount && ((formGroup.value.participantType === 'All') || 
        (formGroup.value.participantType === 'Selected' && selectedParticipants().length > 0)
      )) {
        <div class="bg-primary/10 dark:bg-primary/20 rounded-lg p-4 mb-6">
          <h3 class="font-semibold text-base-content mb-3 flex items-center gap-2">
            <i class="fas fa-calculator text-primary"></i>
            {{ 'operations.splitSummary' | translate }}
          </h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-base-content/70">{{ 'operations.totalAmount' | translate }}:</span>
              <span class="font-bold text-base-content">{{ formatCurrency(formGroup.value.amount!, formGroup.value.currencyId || 1) }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-base-content/70">{{ 'operations.participants' | translate }}:</span>
              <span class="font-bold text-base-content">
                @if (formGroup.value.participantType === 'All') {
                  {{ members().length }}
                } @else {
                  {{ selectedParticipants().length }}
                }
              </span>
            </div>
            
            @if (formGroup.value.splitType === 'Equal') {
              <div class="flex justify-between pt-2 border-t border-base-300">
                <span class="text-base-content/70">{{ 'operations.perPerson' | translate }}:</span>
                <span class="font-bold text-primary">
                  @if (formGroup.value.participantType === 'All') {
                    {{ formatCurrency(formGroup.value.amount! / members().length, formGroup.value.currencyId || 1) }}
                  } @else {
                    {{ formatCurrency(formGroup.value.amount! / selectedParticipants().length, formGroup.value.currencyId || 1) }}
                  }
                </span>
              </div>
            }

            <!-- File Info -->
            @if (selectedFile()) {
              <div class="flex justify-between items-center pt-2 border-t border-base-300">
                <span class="text-base-content/70">{{ 'operations.attachedFile' | translate }}:</span>
                <span class="font-bold text-success flex items-center gap-1">
                  <i class="fas fa-paperclip"></i>
                  {{ selectedFile()!.name }}
                </span>
              </div>
            }
          </div>
        </div>
      }

      <!-- Action Buttons -->
      <footer class="flex justify-between items-center pt-6 gap-4">
        <button
          type="button"
          class="btn btn-outline btn-primary flex items-center gap-2 transition-all duration-200 hover:scale-105"
          [disabled]="isLoading()"
          (click)="goBack()"
        >
          <i class="fas fa-arrow-left text-sm"></i>
          {{ 'upsertTransaction.cancel' | translate }}
        </button>
        @if (isSubmitting()) {
          <button
            type="button"
            class="btn btn-primary flex items-center gap-2 loading-btn"
          >
            <span class="loading loading-spinner loading-xs"></span>
            {{ 'upsertTransaction.saving' | translate }}
          </button>
        } @else {
          <button
            role="button"
            type="submit"
            class="btn btn-primary flex items-center gap-2 transition-all duration-200 hover:scale-105"
            [disabled]="formGroup.invalid || isSubmitting()"
            [class.btn-disabled]="formGroup.invalid || isSubmitting()"
          >
            <i class="fas fa-cloud-arrow-up text-sm"></i>
            {{ 'upsertTransaction.save' | translate }}
          </button>
        }
      </footer>
    </form>
  </article>
</section>