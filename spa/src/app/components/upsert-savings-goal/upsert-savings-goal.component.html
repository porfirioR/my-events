<section class="container mx-auto px-4 py-8">
  <article class="max-w-3xl mx-auto bg-base-200 dark:bg-base-300 rounded-xl shadow-lg p-6 border-indigo-500 ring-indigo-500 ring-1">
    <header class="mb-6">
      <div class="flex items-center justify-between">
        <button
          type="button"
          class="btn btn-sm btn-ghost btn-circle"
          [routerLink]="['/savings']"
        >
          <i class="fas fa-arrow-left" aria-hidden="true"></i>
        </button>
        <h1 class="text-xl font-bold leading-tight tracking-tight text-base-content md:text-2xl transition-colors duration-300">
          {{ isEditMode ? ('upsertSavingsGoal.editTitle' | translate) : ('upsertSavingsGoal.newTitle' | translate) }}
        </h1>
        <button type="button" class="btn btn-ghost btn-sm btn-circle" (click)="cancel()">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </header>

    <form [formGroup]="formGroup" (keydown.enter)="save($event)" (submit)="save()" class="space-y-4">
      <!-- Nombre -->
      <app-text 
        formControlName="name" 
        type="text" 
        [label]="'upsertSavingsGoal.goalName' | translate"
        id="name" 
        name="name"
        [description]="'upsertSavingsGoal.goalNameExample' | translate"
        [disabled]="saving" 
      />

      <!-- Descripción -->
      <app-text-area-input
        formControlName="description"
        [label]="'upsertSavingsGoal.descriptionOptional' | translate"
        [placeholder]="'upsertSavingsGoal.descriptionPlaceholder' | translate"
        id="description"
        name="description"
        [disabled]="saving"
      />

      <!-- Fecha de inicio -->
      <app-date-input 
        formControlName="startDate" 
        [label]="'upsertSavingsGoal.startDate' | translate"
        id="startDate" 
        name="startDate" 
        [disabled]="saving" 
      />

      <!-- Moneda -->
      <app-select-input
        formControlName="currencyId"
        id="currency"
        [label]="'upsertSavingsGoal.currency' | translate"
        name="currency"
        [list]="currencyList"
        [disabled]="saving"
      />

      <!-- Tipo de Progresión -->
      <app-select-input
        formControlName="progressionTypeId"
        id="progressionType"
        [label]="'upsertSavingsGoal.progressionType' | translate"
        name="progressionType"
        [list]="progressionTypeList"
        [description]="'upsertSavingsGoal.selectHowToSave' | translate"
        [disabled]="saving"
      />

      <!-- FreeForm: Target Amount manual -->
      @if (showTargetAmountInput()) {
      <div class="mt-4 p-4 bg-info/10 border border-info rounded-lg">
        <div class="flex items-start gap-2 mb-3">
          <i class="fas fa-info-circle text-info mt-1"></i>
          <div>
            <h3 class="font-semibold text-base-content">{{ 'upsertSavingsGoal.freeFormTitle' | translate }}</h3>
            <p class="text-sm text-base-content/70">{{ 'upsertSavingsGoal.freeFormDescription' | translate }}</p>
          </div>
        </div>

        <app-text 
          formControlName="targetAmount" 
          type="number" 
          [label]="'upsertSavingsGoal.targetAmount' | translate"
          id="targetAmount"
          name="targetAmount" 
          [description]="'upsertSavingsGoal.yourSavingsGoal' | translate"
          [disabled]="saving" 
        />
      </div>
      }

      <!-- Otros tipos: Campos de cuotas -->
      @if (showInstallmentFields()) {
        <div class="mt-4 space-y-4 p-4 bg-base-100 dark:bg-base-200 rounded-lg border border-base-300">
          <div class="flex items-start gap-2">
            <i class="fas fa-calculator text-primary mt-1"></i>
            <div>
              <h3 class="font-semibold text-base-content">{{ 'upsertSavingsGoal.installmentConfigTitle' | translate }}</h3>
              <p class="text-sm text-base-content/70">{{ 'upsertSavingsGoal.installmentConfigDescription' | translate }}</p>
            </div>
          </div>

          <app-text
            formControlName="numberOfInstallments"
            type="number"
            [label]="'upsertSavingsGoal.numberOfInstallments' | translate"
            id="numberOfInstallments"
            name="numberOfInstallments"
            [description]="'upsertSavingsGoal.numberOfInstallmentsExample' | translate"
            [disabled]="saving"
          />

          <!-- Fixed: Mostrar Base Amount -->
          @if (showBaseAmountField()) {
            <app-text
              formControlName="baseAmount"
              type="number"
              [label]="'upsertSavingsGoal.amountPerInstallment' | translate"
              id="baseAmount"
              name="baseAmount"
              [description]="'upsertSavingsGoal.sameAmountDescription' | translate"
              [disabled]="saving"
            />
          }

          <!-- Ascending/Descending/Random: Mostrar Increment Amount -->
          @if (showIncrementField()) {
            <app-text
              formControlName="incrementAmount"
              type="number"
              [label]="'upsertSavingsGoal.incrementAmount' | translate"
              id="incrementAmount"
              name="incrementAmount"
              [description]="getIncrementDescription()"
              [disabled]="saving"
            />

            <!-- Mostrar el Base Amount calculado -->
            @if (calculatedBaseAmount() !== null) {
              <div class="alert alert-info alert-soft mt-1 border-2">
                <i class="fas fa-info-circle"></i>
                <div>
                  <h4 class="font-semibold">{{ 'upsertSavingsGoal.firstInstallment' | translate }}</h4>
                  <p>{{ formatCurrency(calculatedBaseAmount()!, formGroup.value.currencyId) }}</p>
                </div>
              </div>
            }
          }

          <!-- Mostrar target amount calculado -->
          @if (calculatedTargetAmount() !== null) {
            <div class="alert alert-success shadow-lg alert-soft">
              <div class="flex items-center gap-3">
                <i class="fas fa-piggy-bank text-2xl"></i>
                <div>
                  <h4 class="font-semibold">{{ 'upsertSavingsGoal.calculatedTargetAmount' | translate }}</h4>
                  <p class="text-lg font-bold">{{ formatCurrency(calculatedTargetAmount()!, formGroup.value.currencyId) }}</p>
                  <p class="text-xs opacity-80">
                    {{ 'upsertSavingsGoal.installmentsCount' | translate }}
                    @if (showIncrementField()) {
                      <span> ({{ getProgressionDescription() }})</span>
                    }
                  </p>
                </div>
              </div>
            </div>
          }
        </div>
      }

      <!-- Fecha esperada de finalización (opcional) -->
      <app-date-input 
        formControlName="expectedEndDate" 
        [label]="'upsertSavingsGoal.expectedEndDate' | translate"
        id="expectedEndDate"
        name="expectedEndDate" 
        [disabled]="saving" 
      />

      <!-- Action Buttons -->
      <footer class="flex justify-between items-center pt-6 gap-4">
        <button
          type="button"
          class="btn btn-outline btn-primary flex items-center gap-2 transition-all duration-200 hover:scale-105"
          [disabled]="saving"
          (click)="cancel()"
        >
          <i class="fas fa-arrow-left text-sm"></i>
          {{ 'upsertSavingsGoal.cancel' | translate }}
        </button>

        @if (saving) {
          <button
            type="button"
            class="btn btn-primary flex items-center gap-2 loading-btn"
          >
            <span class="loading loading-spinner loading-xs"></span>
            {{ 'upsertSavingsGoal.saving' | translate }}
          </button>
        } @else {
          <button
            role="button"
            type="submit"
            class="btn btn-primary flex items-center gap-2 transition-all duration-200 hover:scale-105"
            [disabled]="formGroup.invalid || saving"
            [class.btn-disabled]="formGroup.invalid || saving"
          >
            <i class="fas fa-cloud-arrow-up text-sm"></i>
            {{ 'upsertSavingsGoal.saveGoal' | translate }}
          </button>
        }
      </footer>
    </form>
  </article>
</section>